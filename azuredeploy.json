{
    "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "rgName": {
            "type": "string"
        },
        "readerRoleAssignmentGuid": {
            "type": "string",
            "defaultValue": "[guid(subscription().subscriptionId, parameters('rgName'))]"
        },
        "contributorRoleAssignmentGuid": {
            "type": "string",
            "defaultValue": "[guid(parameters('rgName'))]"
        },
        "projectLocation": {
            "type": "String"
        },
        "_artifactsLocation": {
            "type": "string",
            "defaultValue": "[deployment().properties.templateLink.uri]",
            "metadata": {
                "description": "The base URI where artifacts required by this template are located"
            }
        },
        "artifactsLocationSasToken": {
            "type": "securestring",
            "defaultValue": "",
            "metadata": {
                "description": "The sasToken required to access _artifactsLocation. When the template is deployed using the accompanying scripts, a sasToken will be grabbed from parameters."
            }
        },
        "storageAccountName": {
            "type": "String"
        },
        "automationAccountName": {
            "type": "String"
        },
        "sqlServerName": {
            "type": "String"
        },
        "sqlDatabaseName": {
            "type": "String",
            "defaultValue": "azureoptimization"
        },
        "logAnalyticsReuse": {
            "type": "bool"
        },
        "logAnalyticsWorkspaceName": {
            "type": "String"
        },
        "logAnalyticsWorkspaceRG": {
            "type": "String"
        },
        "logAnalyticsRetentionDays": {
            "type": "int",
            "defaultValue": 120
        },
        "sqlBackupRetentionDays": {
            "type": "int",
            "defaultValue": 7
        },
        "sqlAdminLogin": {
            "type": "String"
        },
        "sqlAdminPassword": {
            "type": "securestring"
        },
        "cloudEnvironment": {
            "type": "String",
            "defaultValue": "AzureCloud"
        },
        "authenticationOption": {
            "type": "String",
            "defaultValue": "ManagedIdentity"
        },
        "baseTime": {
            "type": "string",
            "defaultValue": "[utcNow('u')]",
            "metadata": {
                "description": "Base time for all automation runbook schedules."
            }
        }
    },
    "functions": [],
    "variables": {
        "roleReader": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Authorization/roleDefinitions/', 'acdd72a7-3385-48ef-bd42-f606fba81ae7')]"
    },
    "resources": [
        {
            "name": "[parameters('rgName')]",
            "type": "Microsoft.Resources/resourceGroups",
            "apiVersion": "2021-04-01",
            "location": "[parameters('projectLocation')]",
            "dependsOn": [],
            "tags": {}
        },
        {
            "name": "resourcesDeployment",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2021-04-01",
            "resourceGroup": "[parameters('rgName')]",
            "dependsOn": [
                "[parameters('rgName')]"
            ],
            "properties": {
                "mode": "Incremental",
                "expressionEvaluationOptions": {
                    "scope": "inner"
                },
                "parameters": {
                    "projectLocation": {
                        "value": "[parameters('projectLocation')]"
                    },
                    "_artifactsLocation": {
                        "value": "[parameters('_artifactsLocation')]"
                    },
                    "artifactsLocationSasToken": {
                        "value": "[parameters('artifactsLocationSasToken')]"
                    },
                    "storageAccountName": {
                        "value": "[parameters('storageAccountName')]"
                    },
                    "automationAccountName": {
                        "value": "[parameters('automationAccountName')]"
                    },
                    "sqlServerName": {
                        "value": "[parameters('sqlServerName')]"
                    },
                    "sqlDatabaseName": {
                        "value": "[parameters('sqlDatabaseName')]"
                    },
                    "logAnalyticsReuse": {
                        "value": "[parameters('logAnalyticsReuse')]"
                    },
                    "logAnalyticsWorkspaceName": {
                        "value": "[parameters('logAnalyticsWorkspaceName')]"
                    },
                    "logAnalyticsWorkspaceRG": {
                        "value": "[parameters('logAnalyticsWorkspaceRG')]"
                    },
                    "logAnalyticsRetentionDays": {
                        "value": "[parameters('logAnalyticsRetentionDays')]"
                    },
                    "sqlBackupRetentionDays": {
                        "value": "[parameters('sqlBackupRetentionDays')]"
                    },
                    "sqlAdminLogin": {
                        "value": "[parameters('sqlAdminLogin')]"
                    },
                    "sqlAdminPassword": {
                        "value": "[parameters('sqlAdminPassword')]"
                    },
                    "cloudEnvironment": {
                        "value": "[parameters('cloudEnvironment')]"
                    },
                    "authenticationOption": {
                        "value": "[parameters('authenticationOption')]"
                    },
                    "baseTime": {
                        "value": "[parameters('baseTime')]"
                    },
                    "contributorRoleAssignmentGuid": {
                        "value": "[parameters('contributorRoleAssignmentGuid')]"
                    }
                },
                "template": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "1.0.0.0",
                    "parameters": {
                        "projectLocation": {
                            "type": "String"
                        },
                        "_artifactsLocation": {
                            "type": "string"
                        },
                        "artifactsLocationSasToken": {
                            "type": "securestring"
                        },
                        "storageAccountName": {
                            "type": "String"
                        },
                        "automationAccountName": {
                            "type": "String"
                        },
                        "sqlServerName": {
                            "type": "String"
                        },
                        "sqlDatabaseName": {
                            "type": "String"
                        },
                        "logAnalyticsReuse": {
                            "type": "bool"
                        },
                        "logAnalyticsWorkspaceName": {
                            "type": "String"
                        },
                        "logAnalyticsWorkspaceRG": {
                            "type": "String"
                        },
                        "logAnalyticsRetentionDays": {
                            "type": "int"
                        },
                        "sqlBackupRetentionDays": {
                            "type": "int"
                        },
                        "sqlAdminLogin": {
                            "type": "String"
                        },
                        "sqlAdminPassword": {
                            "type": "securestring"
                        },
                        "cloudEnvironment": {
                            "type": "String"
                        },
                        "authenticationOption": {
                            "type": "String"
                        },
                        "baseTime": {
                            "type": "string"
                        },
                        "contributorRoleAssignmentGuid": {
                            "type": "string"
                        },
                        "argDiskExportJobId": {
                            "type": "string",
                            "defaultValue": "[newGuid()]",
                            "metadata": {
                                "description": "GUID for the ARG Disk Export job schedule creation - create a unique before deploy"
                            }
                        },
                        "argVhdExportJobId": {
                            "type": "string",
                            "defaultValue": "[newGuid()]",
                            "metadata": {
                                "description": "GUID for the ARG VHD Export job schedule creation - create a unique before deploy"
                            }
                        },
                        "argVmExportJobId": {
                            "type": "string",
                            "defaultValue": "[newGuid()]",
                            "metadata": {
                                "description": "GUID for the ARG VM Export job schedule creation - create a unique before deploy"
                            }
                        },
                        "argVmssExportJobId": {
                            "type": "string",
                            "defaultValue": "[newGuid()]",
                            "metadata": {
                                "description": "GUID for the ARG VMSS Export job schedule creation - create a unique before deploy"
                            }
                        },
                        "argAvailSetExportJobId": {
                            "type": "string",
                            "defaultValue": "[newGuid()]",
                            "metadata": {
                                "description": "GUID for the ARG Availability Set Export job schedule creation - create a unique before deploy"
                            }
                        },
                        "advisorExportJobId": {
                            "type": "string",
                            "defaultValue": "[newGuid()]",
                            "metadata": {
                                "description": "GUID for the Advisor Export job schedule creation - create a unique before deploy"
                            }
                        },
                        "consumptionExportJobId": {
                            "type": "string",
                            "defaultValue": "[newGuid()]",
                            "metadata": {
                                "description": "GUID for the Consumption Export job schedule creation - create a unique before deploy"
                            }
                        },
                        "aadObjectsExportJobId": {
                            "type": "string",
                            "defaultValue": "[newGuid()]",
                            "metadata": {
                                "description": "GUID for the Azure AD Objects Export job schedule creation - create a unique before deploy"
                            }
                        },
                        "argLoadBalancersExportJobId": {
                            "type": "string",
                            "defaultValue": "[newGuid()]",
                            "metadata": {
                                "description": "GUID for the Load Balancers Export job schedule creation - create a unique before deploy"
                            }
                        },
                        "argAppGWsExportJobId": {
                            "type": "string",
                            "defaultValue": "[newGuid()]",
                            "metadata": {
                                "description": "GUID for the Application Gateways Export job schedule creation - create a unique before deploy"
                            }
                        },
                        "rbacExportJobId": {
                            "type": "string",
                            "defaultValue": "[newGuid()]",
                            "metadata": {
                                "description": "GUID for the RBAC Export job schedule creation - create a unique before deploy"
                            }
                        },
                        "argResContainersExportJobId": {
                            "type": "string",
                            "defaultValue": "[newGuid()]",
                            "metadata": {
                                "description": "GUID for the Resource Containers Export job schedule creation - create a unique before deploy"
                            }
                        },
                        "argNICExportJobId": {
                            "type": "string",
                            "defaultValue": "[newGuid()]",
                            "metadata": {
                                "description": "GUID for the NIC Export job schedule creation - create a unique before deploy"
                            }
                        },
                        "argNSGExportJobId": {
                            "type": "string",
                            "defaultValue": "[newGuid()]",
                            "metadata": {
                                "description": "GUID for the NSG Export job schedule creation - create a unique before deploy"
                            }
                        },
                        "argPublicIPExportJobId": {
                            "type": "string",
                            "defaultValue": "[newGuid()]",
                            "metadata": {
                                "description": "GUID for the Public IP Export job schedule creation - create a unique before deploy"
                            }
                        },
                        "argVNetExportJobId": {
                            "type": "string",
                            "defaultValue": "[newGuid()]",
                            "metadata": {
                                "description": "GUID for the VNet Export job schedule creation - create a unique before deploy"
                            }
                        },
                        "monitorVmssCpuMaxExportJobId": {
                            "type": "string",
                            "defaultValue": "[newGuid()]",
                            "metadata": {
                                "description": "GUID for the Monitor Metrics Export job schedule creation - create a unique before deploy"
                            }
                        },
                        "monitorVmssCpuAvgExportJobId": {
                            "type": "string",
                            "defaultValue": "[newGuid()]",
                            "metadata": {
                                "description": "GUID for the Monitor Metrics Export job schedule creation - create a unique before deploy"
                            }
                        },
                        "monitorVmssMemoryMinExportJobId": {
                            "type": "string",
                            "defaultValue": "[newGuid()]",
                            "metadata": {
                                "description": "GUID for the Monitor Metrics Export job schedule creation - create a unique before deploy"
                            }
                        },
                        "argDiskIngestJobId": {
                            "type": "string",
                            "defaultValue": "[newGuid()]",
                            "metadata": {
                                "description": "GUID for the ARG Disk Ingest job schedule creation - create a unique before deploy"
                            }
                        },
                        "argVhdIngestJobId": {
                            "type": "string",
                            "defaultValue": "[newGuid()]",
                            "metadata": {
                                "description": "GUID for the ARG VHD Ingest job schedule creation - create a unique before deploy"
                            }
                        },
                        "argVmIngestJobId": {
                            "type": "string",
                            "defaultValue": "[newGuid()]",
                            "metadata": {
                                "description": "GUID for the ARG VM Ingest job schedule creation - create a unique before deploy"
                            }
                        },
                        "argVmssIngestJobId": {
                            "type": "string",
                            "defaultValue": "[newGuid()]",
                            "metadata": {
                                "description": "GUID for the ARG VMSS Ingest job schedule creation - create a unique before deploy"
                            }
                        },
                        "argAvailSetIngestJobId": {
                            "type": "string",
                            "defaultValue": "[newGuid()]",
                            "metadata": {
                                "description": "GUID for the ARG Availability Set Ingest job schedule creation - create a unique before deploy"
                            }
                        },
                        "advisorIngestJobId": {
                            "type": "string",
                            "defaultValue": "[newGuid()]",
                            "metadata": {
                                "description": "GUID for the Advisor Ingest job schedule creation - create a unique before deploy"
                            }
                        },
                        "remediationLogsIngestJobId": {
                            "type": "string",
                            "defaultValue": "[newGuid()]",
                            "metadata": {
                                "description": "GUID for the Remediation Logs Ingest job schedule creation - create a unique before deploy"
                            }
                        },
                        "consumptionIngestJobId": {
                            "type": "string",
                            "defaultValue": "[newGuid()]",
                            "metadata": {
                                "description": "GUID for the Consumption Ingest job schedule creation - create a unique before deploy"
                            }
                        },
                        "aadObjectsIngestJobId": {
                            "type": "string",
                            "defaultValue": "[newGuid()]",
                            "metadata": {
                                "description": "GUID for the AAD Objects Ingest job schedule creation - create a unique before deploy"
                            }
                        },
                        "argLoadBalancersIngestJobId": {
                            "type": "string",
                            "defaultValue": "[newGuid()]",
                            "metadata": {
                                "description": "GUID for the Load Balancers Ingest job schedule creation - create a unique before deploy"
                            }
                        },
                        "argAppGWsIngestJobId": {
                            "type": "string",
                            "defaultValue": "[newGuid()]",
                            "metadata": {
                                "description": "GUID for the Application Gateways Ingest job schedule creation - create a unique before deploy"
                            }
                        },
                        "argResContainersIngestJobId": {
                            "type": "string",
                            "defaultValue": "[newGuid()]",
                            "metadata": {
                                "description": "GUID for the Resource Containers Ingest job schedule creation - create a unique before deploy"
                            }
                        },
                        "rbacIngestJobId": {
                            "type": "string",
                            "defaultValue": "[newGuid()]",
                            "metadata": {
                                "description": "GUID for the RBAC Ingest job schedule creation - create a unique before deploy"
                            }
                        },
                        "argNICIngestJobId": {
                            "type": "string",
                            "defaultValue": "[newGuid()]",
                            "metadata": {
                                "description": "GUID for the NIC Ingest job schedule creation - create a unique before deploy"
                            }
                        },
                        "argNSGIngestJobId": {
                            "type": "string",
                            "defaultValue": "[newGuid()]",
                            "metadata": {
                                "description": "GUID for the NSG Ingest job schedule creation - create a unique before deploy"
                            }
                        },
                        "argPublicIPIngestJobId": {
                            "type": "string",
                            "defaultValue": "[newGuid()]",
                            "metadata": {
                                "description": "GUID for the Public IP Ingest job schedule creation - create a unique before deploy"
                            }
                        },
                        "argVNetIngestJobId": {
                            "type": "string",
                            "defaultValue": "[newGuid()]",
                            "metadata": {
                                "description": "GUID for the VNet Ingest job schedule creation - create a unique before deploy"
                            }
                        },
                        "monitorIngestJobId": {
                            "type": "string",
                            "defaultValue": "[newGuid()]",
                            "metadata": {
                                "description": "GUID for the Azure Monitor Metrics Ingest job schedule creation - create a unique before deploy"
                            }
                        },
                        "unattachedDisksRecommendationJobId": {
                            "type": "string",
                            "defaultValue": "[newGuid()]",
                            "metadata": {
                                "description": "GUID for the Unattached Disks Recommendation Generation job schedule creation - create a unique before deploy"
                            }
                        },
                        "advisorCostAugmentedRecommendationJobId": {
                            "type": "string",
                            "defaultValue": "[newGuid()]",
                            "metadata": {
                                "description": "GUID for the Augmented Advisor Cost Recommendation Generation job schedule creation - create a unique before deploy"
                            }
                        },
                        "advisorAsIsRecommendationJobId": {
                            "type": "string",
                            "defaultValue": "[newGuid()]",
                            "metadata": {
                                "description": "GUID for the Advisor General Recommendations Generation job schedule creation - create a unique before deploy"
                            }
                        },
                        "vmsHaRecommendationJobId": {
                            "type": "string",
                            "defaultValue": "[newGuid()]",
                            "metadata": {
                                "description": "GUID for the VMs High Availability Recommendation Generation job schedule creation - create a unique before deploy"
                            }
                        },
                        "longDeallocatedVmsRecommendationJobId": {
                            "type": "string",
                            "defaultValue": "[newGuid()]",
                            "metadata": {
                                "description": "GUID for the Long Deallocated VMs Recommendation Generation job schedule creation - create a unique before deploy"
                            }
                        },
                        "aadExpiringCredsRecommendationJobId": {
                            "type": "string",
                            "defaultValue": "[newGuid()]",
                            "metadata": {
                                "description": "GUID for the AAD Objects with Expiring Credentials Recommendation Generation job schedule creation - create a unique before deploy"
                            }
                        },
                        "unusedLoadBalancersRecommendationJobId": {
                            "type": "string",
                            "defaultValue": "[newGuid()]",
                            "metadata": {
                                "description": "GUID for the Unused Load Balancers Recommendation Generation job schedule creation - create a unique before deploy"
                            }
                        },
                        "unusedAppGWsRecommendationJobId": {
                            "type": "string",
                            "defaultValue": "[newGuid()]",
                            "metadata": {
                                "description": "GUID for the Unused Application Gateways Recommendation Generation job schedule creation - create a unique before deploy"
                            }
                        },
                        "armOptimizationsRecommendationJobId": {
                            "type": "string",
                            "defaultValue": "[newGuid()]",
                            "metadata": {
                                "description": "GUID for the ARM Optimizations Recommendation Generation job schedule creation - create a unique before deploy"
                            }
                        },
                        "vnetOptimizationsRecommendationJobId": {
                            "type": "string",
                            "defaultValue": "[newGuid()]",
                            "metadata": {
                                "description": "GUID for the VNet Optimizations Recommendation Generation job schedule creation - create a unique before deploy"
                            }
                        },
                        "vmssOptimizationsRecommendationJobId": {
                            "type": "string",
                            "defaultValue": "[newGuid()]",
                            "metadata": {
                                "description": "GUID for the VMSS Optimizations Recommendation Generation job schedule creation - create a unique before deploy"
                            }
                        },
                        "recommendationsIngestJobId": {
                            "type": "string",
                            "defaultValue": "[newGuid()]",
                            "metadata": {
                                "description": "GUID for the Recommendations Ingest job schedule creation - create a unique before deploy"
                            }
                        }
                    },
                    "variables": {
                        // CSV exports runbooks
                        "advisorExportsRunbookName": "Export-AdvisorRecommendationsToBlobStorage",
                        "argVmExportsRunbookName": "Export-ARGVirtualMachinesPropertiesToBlobStorage",
                        "argVmssExportsRunbookName": "Export-ARGVMSSPropertiesToBlobStorage",
                        "argDisksExportsRunbookName": "Export-ARGManagedDisksPropertiesToBlobStorage",
                        "argVhdExportsRunbookName": "Export-ARGUnmanagedDisksPropertiesToBlobStorage",
                        "argAvailSetExportsRunbookName": "Export-ARGAvailabilitySetPropertiesToBlobStorage",
                        "consumptionExportsRunbookName": "Export-ConsumptionToBlobStorage",
                        "aadObjectsExportsRunbookName": "Export-AADObjectsToBlobStorage",
                        "argLoadBalancersExportsRunbookName": "Export-ARGLoadBalancerPropertiesToBlobStorage",
                        "argAppGWsExportsRunbookName": "Export-ARGAppGatewayPropertiesToBlobStorage",
                        "argResContainersExportsRunbookName": "Export-ARGResourceContainersPropertiesToBlobStorage",
                        "rbacExportsRunbookName": "Export-RBACAssignmentsToBlobStorage",
                        "argNICExportsRunbookName": "Export-ARGNICPropertiesToBlobStorage",
                        "argNSGExportsRunbookName": "Export-ARGNSGPropertiesToBlobStorage",
                        "argVNetExportsRunbookName": "Export-ARGVNetPropertiesToBlobStorage",
                        "argPublicIpExportsRunbookName": "Export-ARGPublicIpPropertiesToBlobStorage",
                        "monitorExportsRunbookName": "Export-AzMonitorMetricsToBlobStorage",
                        // CSV exports schedules
                        "advisorExportsScheduleName": "AzureOptimization_ExportAdvisorWeekly",
                        "argExportsScheduleName": "AzureOptimization_ExportARGDaily",
                        "consumptionExportsScheduleName": "AzureOptimization_ExportConsumptionDaily",
                        "aadObjectsExportsScheduleName": "AzureOptimization_ExportAADObjectsDaily",
                        "rbacExportsScheduleName": "AzureOptimization_ExportRBACDaily",
                        "monitorVmssCpuMaxExportsScheduleName": "AzureOptimization_ExportMonitorVmssCpuMaxHourly",
                        "monitorVmssCpuAvgExportsScheduleName": "AzureOptimization_ExportMonitorVmssCpuAvgHourly",
                        "monitorVmssMemoryMinExportsScheduleName": "AzureOptimization_ExportMonitorVmssMemoryMinHourly",
                        "csvExportsSchedules": [
                            {
                                "exportSchedule": "[variables('argExportsScheduleName')]",
                                "exportDescription": "Daily Azure Resource Graph exports",
                                "exportTimeOffset": "PT1H",
                                "exportFrequency": "Day"
                            },
                            {
                                "exportSchedule": "[variables('advisorExportsScheduleName')]",
                                "exportDescription": "Weekly Azure Advisor exports",
                                "exportTimeOffset": "PT1H15M",
                                "exportFrequency": "Week"
                            },
                            {
                                "exportSchedule": "[variables('consumptionExportsScheduleName')]",
                                "exportDescription": "Daily Azure Consumption exports",
                                "exportTimeOffset": "PT1H",
                                "exportFrequency": "Day"
                            },
                            {
                                "exportSchedule": "[variables('aadObjectsExportsScheduleName')]",
                                "exportDescription": "Daily Azure AD Objects exports",
                                "exportTimeOffset": "PT1H",
                                "exportFrequency": "Day"
                            },
                            {
                                "exportSchedule": "[variables('rbacExportsScheduleName')]",
                                "exportDescription": "Daily Azure RBAC exports",
                                "exportTimeOffset": "PT1H",
                                "exportFrequency": "Day"
                            },
                            {
                                "exportSchedule": "[variables('monitorVmssCpuAvgExportsScheduleName')]",
                                "exportDescription": "Hourly Azure Monitor metrics exports for VMSS Percentage CPU (Avg.)",
                                "exportTimeOffset": "PT1H15M",
                                "exportFrequency": "Hour"
                            },
                            {
                                "exportSchedule": "[variables('monitorVmssCpuMaxExportsScheduleName')]",
                                "exportDescription": "Hourly Azure Monitor metrics exports for VMSS Percentage CPU (Max.)",
                                "exportTimeOffset": "PT1H15M",
                                "exportFrequency": "Hour"
                            },
                            {
                                "exportSchedule": "[variables('monitorVmssMemoryMinExportsScheduleName')]",
                                "exportDescription": "Hourly Azure Monitor metrics exports for VMSS Available Memory (Min.)",
                                "exportTimeOffset": "PT1H15M",
                                "exportFrequency": "Hour"
                            }
                        ],
                        "csvExports": [
                            {
                                "runbookName": "[variables('advisorExportsRunbookName')]",
                                "isOneToMany": false,
                                "containerName": "advisorexports",
                                "variableName": "AzureOptimization_AdvisorContainer",
                                "variableDescription": "The Storage Account container where Azure Advisor exports are dumped to",
                                "ingestSchedule": "AzureOptimization_IngestAdvisorWeekly",
                                "ingestDescription": "Weekly Azure Advisor recommendations ingests",
                                "ingestTimeOffset": "PT1H45M",
                                "ingestFrequency": "Week",
                                "ingestJobId": "[parameters('advisorIngestJobId')]",
                                "exportSchedule": "[variables('advisorExportsScheduleName')]",
                                "exportJobId": "[parameters('advisorExportJobId')]"
                            },
                            {
                                "runbookName": "[variables('argVmExportsRunbookName')]",
                                "isOneToMany": false,
                                "containerName": "argvmexports",
                                "variableName": "AzureOptimization_ARGVMContainer",
                                "variableDescription": "The Storage Account container where Azure Resource Graph Virtual Machine exports are dumped to",
                                "ingestSchedule": "AzureOptimization_IngestARGVMsDaily",
                                "ingestDescription": "Daily Azure Resource Graph Virtual Machines ingests",
                                "ingestTimeOffset": "PT1H30M",
                                "ingestFrequency": "Day",
                                "ingestJobId": "[parameters('argVmIngestJobId')]",
                                "exportSchedule": "[variables('argExportsScheduleName')]",
                                "exportJobId": "[parameters('argVmExportJobId')]"
                            },
                            {
                                "runbookName": "[variables('argVmssExportsRunbookName')]",
                                "isOneToMany": false,
                                "containerName": "argvmssexports",
                                "variableName": "AzureOptimization_ARGVMSSContainer",
                                "variableDescription": "The Storage Account container where Azure Resource Graph VMSS exports are dumped to",
                                "ingestSchedule": "AzureOptimization_IngestARGVMSSDaily",
                                "ingestDescription": "Daily Azure Resource Graph VMSS ingests",
                                "ingestTimeOffset": "PT1H30M",
                                "ingestFrequency": "Day",
                                "ingestJobId": "[parameters('argVmssIngestJobId')]",
                                "exportSchedule": "[variables('argExportsScheduleName')]",
                                "exportJobId": "[parameters('argVmssExportJobId')]"
                            },
                            {
                                "runbookName": "[variables('argDisksExportsRunbookName')]",
                                "isOneToMany": false,
                                "containerName": "argdiskexports",
                                "variableName": "AzureOptimization_ARGDiskContainer",
                                "variableDescription": "The Storage Account container where Azure Resource Graph Managed Disks exports are dumped to",
                                "ingestSchedule": "AzureOptimization_IngestARGDisksDaily",
                                "ingestDescription": "Daily Azure Resource Graph Managed Disks ingests",
                                "ingestTimeOffset": "PT1H30M",
                                "ingestFrequency": "Day",
                                "ingestJobId": "[parameters('argDiskIngestJobId')]",
                                "exportSchedule": "[variables('argExportsScheduleName')]",
                                "exportJobId": "[parameters('argDiskExportJobId')]"
                            },
                            {
                                "runbookName": "[variables('argVhdExportsRunbookName')]",
                                "isOneToMany": false,
                                "containerName": "argvhdexports",
                                "variableName": "AzureOptimization_ARGVhdContainer",
                                "variableDescription": "The Storage Account container where Azure Resource Graph Unmanaged Disks exports are dumped to",
                                "ingestSchedule": "AzureOptimization_IngestARGVHDsDaily",
                                "ingestDescription": "Daily Azure Resource Graph Unmanaged Disks ingests",
                                "ingestTimeOffset": "PT1H30M",
                                "ingestFrequency": "Day",
                                "ingestJobId": "[parameters('argVhdIngestJobId')]",
                                "exportSchedule": "[variables('argExportsScheduleName')]",
                                "exportJobId": "[parameters('argVhdExportJobId')]"
                            },
                            {
                                "runbookName": "[variables('argAvailSetExportsRunbookName')]",
                                "isOneToMany": false,
                                "containerName": "argavailsetexports",
                                "variableName": "AzureOptimization_ARGAvailabilitySetContainer",
                                "variableDescription": "The Storage Account container where Azure Resource Graph Availability Set exports are dumped to",
                                "ingestSchedule": "AzureOptimization_IngestARGAvailSetsDaily",
                                "ingestDescription": "Daily Azure Resource Graph Availability Sets ingests",
                                "ingestTimeOffset": "PT1H30M",
                                "ingestFrequency": "Day",
                                "ingestJobId": "[parameters('argAvailSetIngestJobId')]",
                                "exportSchedule": "[variables('argExportsScheduleName')]",
                                "exportJobId": "[parameters('argAvailSetExportJobId')]"
                            },
                            {
                                "runbookName": "[variables('consumptionExportsRunbookName')]",
                                "isOneToMany": false,
                                "containerName": "consumptionexports",
                                "variableName": "AzureOptimization_ConsumptionContainer",
                                "variableDescription": "The Storage Account container where Azure Consumption exports are dumped to",
                                "ingestSchedule": "AzureOptimization_IngestConsumptionDaily",
                                "ingestDescription": "Daily Azure Consumption ingests",
                                "ingestTimeOffset": "PT2H",
                                "ingestFrequency": "Day",
                                "ingestJobId": "[parameters('consumptionIngestJobId')]",
                                "exportSchedule": "[variables('consumptionExportsScheduleName')]",
                                "exportJobId": "[parameters('consumptionExportJobId')]"
                            },
                            {
                                "runbookName": "[variables('aadObjectsExportsRunbookName')]",
                                "isOneToMany": false,
                                "containerName": "aadobjectsexports",
                                "variableName": "AzureOptimization_AADObjectsContainer",
                                "variableDescription": "The Storage Account container where Azure AD Objects exports are dumped to",
                                "ingestSchedule": "AzureOptimization_IngestAADObjectsDaily",
                                "ingestDescription": "Daily Azure AD Objects ingests",
                                "ingestTimeOffset": "PT2H",
                                "ingestFrequency": "Day",
                                "ingestJobId": "[parameters('aadObjectsIngestJobId')]",
                                "exportSchedule": "[variables('aadObjectsExportsScheduleName')]",
                                "exportJobId": "[parameters('aadObjectsExportJobId')]"
                            },
                            {
                                "runbookName": "[variables('argLoadBalancersExportsRunbookName')]",
                                "isOneToMany": false,
                                "containerName": "arglbexports",
                                "variableName": "AzureOptimization_ARGLoadBalancerContainer",
                                "variableDescription": "The Storage Account container where Azure Resource Graph Load Balancer exports are dumped to",
                                "ingestSchedule": "AzureOptimization_IngestARGLoadBalancersDaily",
                                "ingestDescription": "Daily Azure Resource Graph Load Balancers ingests",
                                "ingestTimeOffset": "PT1H30M",
                                "ingestFrequency": "Day",
                                "ingestJobId": "[parameters('argLoadBalancersIngestJobId')]",
                                "exportSchedule": "[variables('argExportsScheduleName')]",
                                "exportJobId": "[parameters('argLoadBalancersExportJobId')]"
                            },
                            {
                                "runbookName": "[variables('argAppGWsExportsRunbookName')]",
                                "isOneToMany": false,
                                "containerName": "argappgwexports",
                                "variableName": "AzureOptimization_ARGAppGatewayContainer",
                                "variableDescription": "The Storage Account container where Azure Resource Graph Application Gateway exports are dumped to",
                                "ingestSchedule": "AzureOptimization_IngestARGAppGWsDaily",
                                "ingestDescription": "Daily Azure Resource Graph Application Gateways ingests",
                                "ingestTimeOffset": "PT1H30M",
                                "ingestFrequency": "Day",
                                "ingestJobId": "[parameters('argAppGWsIngestJobId')]",
                                "exportSchedule": "[variables('argExportsScheduleName')]",
                                "exportJobId": "[parameters('argAppGWsExportJobId')]"
                            },
                            {
                                "runbookName": "[variables('argResContainersExportsRunbookName')]",
                                "isOneToMany": false,
                                "containerName": "argrescontainersexports",
                                "variableName": "AzureOptimization_ARGResourceContainersContainer",
                                "variableDescription": "The Storage Account container where Azure Resource Graph Resource Containers exports are dumped to",
                                "ingestSchedule": "AzureOptimization_IngestARGResourceContainersDaily",
                                "ingestDescription": "Daily Azure Resource Graph Resource Containers ingests",
                                "ingestTimeOffset": "PT1H30M",
                                "ingestFrequency": "Day",
                                "ingestJobId": "[parameters('argResContainersIngestJobId')]",
                                "exportSchedule": "[variables('argExportsScheduleName')]",
                                "exportJobId": "[parameters('argResContainersExportJobId')]"
                            },
                            {
                                "runbookName": "[variables('rbacExportsRunbookName')]",
                                "isOneToMany": false,
                                "containerName": "rbacexports",
                                "variableName": "AzureOptimization_RBACAssignmentsContainer",
                                "variableDescription": "The Storage Account container where RBAC Assignments exports are dumped to",
                                "ingestSchedule": "AzureOptimization_IngestRBACDaily",
                                "ingestDescription": "Daily Azure RBAC ingests",
                                "ingestTimeOffset": "PT1H30M",
                                "ingestFrequency": "Day",
                                "ingestJobId": "[parameters('rbacIngestJobId')]",
                                "exportSchedule": "[variables('rbacExportsScheduleName')]",
                                "exportJobId": "[parameters('rbacExportJobId')]"
                            },
                            {
                                "runbookName": "[variables('argNICExportsRunbookName')]",
                                "isOneToMany": false,
                                "containerName": "argnicexports",
                                "variableName": "AzureOptimization_ARGNICContainer",
                                "variableDescription": "The Storage Account container where Azure Resource Graph NIC exports are dumped to",
                                "ingestSchedule": "AzureOptimization_IngestARGNICsDaily",
                                "ingestDescription": "Daily Azure Resource Graph NIC ingests",
                                "ingestTimeOffset": "PT1H30M",
                                "ingestFrequency": "Day",
                                "ingestJobId": "[parameters('argNICIngestJobId')]",
                                "exportSchedule": "[variables('argExportsScheduleName')]",
                                "exportJobId": "[parameters('argNICExportJobId')]"
                            },
                            {
                                "runbookName": "[variables('argNSGExportsRunbookName')]",
                                "isOneToMany": false,
                                "containerName": "argnsgexports",
                                "variableName": "AzureOptimization_ARGNSGContainer",
                                "variableDescription": "The Storage Account container where Azure Resource Graph NSG exports are dumped to",
                                "ingestSchedule": "AzureOptimization_IngestARGNSGsDaily",
                                "ingestDescription": "Daily Azure Resource Graph NSG ingests",
                                "ingestTimeOffset": "PT1H30M",
                                "ingestFrequency": "Day",
                                "ingestJobId": "[parameters('argNSGIngestJobId')]",
                                "exportSchedule": "[variables('argExportsScheduleName')]",
                                "exportJobId": "[parameters('argNSGExportJobId')]"
                            },
                            {
                                "runbookName": "[variables('argVNetExportsRunbookName')]",
                                "isOneToMany": false,
                                "containerName": "argvnetexports",
                                "variableName": "AzureOptimization_ARGVNetContainer",
                                "variableDescription": "The Storage Account container where Azure Resource Graph VNet exports are dumped to",
                                "ingestSchedule": "AzureOptimization_IngestARGVNetsDaily",
                                "ingestDescription": "Daily Azure Resource Graph Virtual Network ingests",
                                "ingestTimeOffset": "PT1H30M",
                                "ingestFrequency": "Day",
                                "ingestJobId": "[parameters('argVNetIngestJobId')]",
                                "exportSchedule": "[variables('argExportsScheduleName')]",
                                "exportJobId": "[parameters('argVNetExportJobId')]"
                            },
                            {
                                "runbookName": "[variables('argPublicIpExportsRunbookName')]",
                                "isOneToMany": false,
                                "containerName": "argpublicipexports",
                                "variableName": "AzureOptimization_ARGPublicIpContainer",
                                "variableDescription": "The Storage Account container where Azure Resource Graph Public IP exports are dumped to",
                                "ingestSchedule": "AzureOptimization_IngestARGPublicIPsDaily",
                                "ingestDescription": "Daily Azure Resource Graph Public IP ingests",
                                "ingestTimeOffset": "PT1H30M",
                                "ingestFrequency": "Day",
                                "ingestJobId": "[parameters('argPublicIPIngestJobId')]",
                                "exportSchedule": "[variables('argExportsScheduleName')]",
                                "exportJobId": "[parameters('argPublicIPExportJobId')]"
                            },
                            {
                                "runbookName": "[variables('monitorExportsRunbookName')]",
                                "isOneToMany": true,
                                "containerName": "azmonitorexports",
                                "variableName": "AzureOptimization_AzMonitorContainer",
                                "variableDescription": "The Storage Account container where Azure Monitor metrics exports are dumped to",
                                "ingestSchedule": "AzureOptimization_IngestAzMonitorMetricsHourly",
                                "ingestDescription": "Hourly Azure Monitor metrics ingests",
                                "ingestTimeOffset": "PT2H",
                                "ingestFrequency": "Hour",
                                "ingestJobId": "[parameters('monitorIngestJobId')]",
                                "exportJobId": "dummy"
                            }
                        ],
                        "csvParameterizedExports": [
                            {
                                "runbookName": "[variables('monitorExportsRunbookName')]",
                                "exportSchedule": "[variables('monitorVmssCpuMaxExportsScheduleName')]",
                                "exportJobId": "[parameters('monitorVmssCpuMaxExportJobId')]",
                                "parameters": {
                                    "ResourceType": "microsoft.compute/virtualmachinescalesets",
                                    "TimeSpan": "01:00:00",
                                    "aggregationType": "Maximum",
                                    "MetricNames": "Percentage CPU",
                                    "TimeGrain": "01:00:00"
                                }
                            },
                            {
                                "runbookName": "[variables('monitorExportsRunbookName')]",
                                "exportSchedule": "[variables('monitorVmssCpuAvgExportsScheduleName')]",
                                "exportJobId": "[parameters('monitorVmssCpuAvgExportJobId')]",
                                "parameters": {
                                    "ResourceType": "microsoft.compute/virtualmachinescalesets",
                                    "TimeSpan": "01:00:00",
                                    "aggregationType": "Average",
                                    "MetricNames": "Percentage CPU",
                                    "TimeGrain": "01:00:00"
                                }
                            },
                            {
                                "runbookName": "[variables('monitorExportsRunbookName')]",
                                "exportSchedule": "[variables('monitorVmssMemoryMinExportsScheduleName')]",
                                "exportJobId": "[parameters('monitorVmssMemoryMinExportJobId')]",
                                "parameters": {
                                    "ResourceType": "microsoft.compute/virtualmachinescalesets",
                                    "TimeSpan": "01:00:00",
                                    "aggregationType": "Minimum",
                                    "MetricNames": "Available Memory Bytes",
                                    "TimeGrain": "01:00:00"
                                }
                            }
                        ],
                        // recommendations runbooks
                        "unattachedDisksRecommendationsRunbookName": "Recommend-UnattachedDisksToBlobStorage",
                        "advisorCostAugmentedRecommendationsRunbookName": "Recommend-AdvisorCostAugmentedToBlobStorage",
                        "advisorAsIsRecommendationsRunbookName": "Recommend-AdvisorAsIsToBlobStorage",
                        "vmsHARecommendationsRunbookName": "Recommend-VMsHighAvailabilityToBlobStorage",
                        "longDeallocatedVmsRecommendationsRunbookName": "Recommend-LongDeallocatedVmsToBlobStorage",
                        "aadExpiringCredsRecommendationsRunbookName": "Recommend-AADExpiringCredentialsToBlobStorage",
                        "unusedLBsRecommendationsRunbookName": "Recommend-UnusedLoadBalancersToBlobStorage",
                        "unusedAppGWsRecommendationsRunbookName": "Recommend-UnusedAppGWsToBlobStorage",
                        "armOptimizationsRecommendationsRunbookName": "Recommend-ARMOptimizationsToBlobStorage",
                        "vnetOptimizationsRecommendationsRunbookName": "Recommend-VNetOptimizationsToBlobStorage",
                        "vmssOptimizationsRecommendationsRunbookName": "Recommend-VMSSOptimizationsToBlobStorage",
                        "recommendations": [
                            {
                                "recommendationJobId": "[parameters('unattachedDisksRecommendationJobId')]",
                                "runbookName": "[variables('unattachedDisksRecommendationsRunbookName')]"
                            },
                            {
                                "recommendationJobId": "[parameters('advisorCostAugmentedRecommendationJobId')]",
                                "runbookName": "[variables('advisorCostAugmentedRecommendationsRunbookName')]"
                            },
                            {
                                "recommendationJobId": "[parameters('advisorAsIsRecommendationJobId')]",
                                "runbookName": "[variables('advisorAsIsRecommendationsRunbookName')]"
                            },
                            {
                                "recommendationJobId": "[parameters('vmsHaRecommendationJobId')]",
                                "runbookName": "[variables('vmsHARecommendationsRunbookName')]"
                            },
                            {
                                "recommendationJobId": "[parameters('longDeallocatedVmsRecommendationJobId')]",
                                "runbookName": "[variables('longDeallocatedVmsRecommendationsRunbookName')]"
                            },
                            {
                                "recommendationJobId": "[parameters('aadExpiringCredsRecommendationJobId')]",
                                "runbookName": "[variables('aadExpiringCredsRecommendationsRunbookName')]"
                            },
                            {
                                "recommendationJobId": "[parameters('unusedLoadBalancersRecommendationJobId')]",
                                "runbookName": "[variables('unusedLBsRecommendationsRunbookName')]"
                            },
                            {
                                "recommendationJobId": "[parameters('unusedAppGWsRecommendationJobId')]",
                                "runbookName": "[variables('unusedAppGWsRecommendationsRunbookName')]"
                            },
                            {
                                "recommendationJobId": "[parameters('armOptimizationsRecommendationJobId')]",
                                "runbookName": "[variables('armOptimizationsRecommendationsRunbookName')]"
                            },
                            {
                                "recommendationJobId": "[parameters('vnetOptimizationsRecommendationJobId')]",
                                "runbookName": "[variables('vnetOptimizationsRecommendationsRunbookName')]"
                            },
                            {
                                "recommendationJobId": "[parameters('vmssOptimizationsRecommendationJobId')]",
                                "runbookName": "[variables('vmssOptimizationsRecommendationsRunbookName')]"
                            }
                        ],
                        "remediationLogsContainerName": "remediationlogs",
                        "recommendationsContainerName": "recommendationsexports",
                        "csvIngestRunbookName": "Ingest-OptimizationCSVExportsToLogAnalytics",
                        "recommendationsIngestRunbookName": "Ingest-RecommendationsToSQLServer",
                        "advisorRightSizeFilteredRemediationRunbookName": "Remediate-AdvisorRightSizeFiltered",
                        "longDeallocatedVMsFilteredRemediationRunbookName": "Remediate-LongDeallocatedVMsFiltered",
                        "unattachedDisksFilteredRemediationRunbookName": "Remediate-UnattachedDisksFiltered",
                        "remediationLogsIngestScheduleName": "AzureOptimization_IngestRemediationLogsDaily",
                        "recommendationsScheduleName": "AzureOptimization_RecommendationsWeekly",
                        "recommendationsIngestScheduleName": "AzureOptimization_IngestRecommendationsWeekly",
                        "apiVersions": {
                            "operationalInsights": "2020-08-01",
                            "automation": "2020-01-13-preview",
                            "storage": "2019-06-01",
                            "sql": "2019-06-01-preview"
                        },
                        "Az.Accounts": {
                            "name": "Az.Accounts",
                            "url": "https://www.powershellgallery.com/api/v2/package/Az.Accounts/2.7.0"
                        },
                        "Microsoft.Graph.Authentication": {
                            "name": "Microsoft.Graph.Authentication",
                            "url": "https://www.powershellgallery.com/api/v2/package/Microsoft.Graph.Authentication/1.9.0"
                        },
                        "psModules": [
                            {
                                "name": "Az.Advisor",
                                "url": "https://www.powershellgallery.com/api/v2/package/Az.Advisor/1.1.2"
                            },
                            {
                                "name": "Az.Compute",
                                "url": "https://www.powershellgallery.com/api/v2/package/Az.Compute/4.21.0"
                            },
                            {
                                "name": "Az.OperationalInsights",
                                "url": "https://www.powershellgallery.com/api/v2/package/Az.OperationalInsights/3.0.0"
                            },
                            {
                                "name": "Az.ResourceGraph",
                                "url": "https://www.powershellgallery.com/api/v2/package/Az.ResourceGraph/0.11.0"
                            },
                            {
                                "name": "Az.Storage",
                                "url": "https://www.powershellgallery.com/api/v2/package/Az.Storage/4.1.0"
                            },
                            {
                                "name": "Az.Resources",
                                "url": "https://www.powershellgallery.com/api/v2/package/Az.Resources/5.1.0"
                            },
                            {
                                "name": "Az.Monitor",
                                "url": "https://www.powershellgallery.com/api/v2/package/Az.Monitor/3.0.0"
                            },
                            {
                                "name": "Microsoft.Graph.Users",
                                "url": "https://www.powershellgallery.com/api/v2/package/Microsoft.Graph.Users/1.9.0"
                            },
                            {
                                "name": "Microsoft.Graph.Groups",
                                "url": "https://www.powershellgallery.com/api/v2/package/Microsoft.Graph.Groups/1.9.0"
                            },
                            {
                                "name": "Microsoft.Graph.Applications",
                                "url": "https://www.powershellgallery.com/api/v2/package/Microsoft.Graph.Applications/1.9.0"
                            },
                            {
                                "name": "Microsoft.Graph.Identity.DirectoryManagement",
                                "url": "https://www.powershellgallery.com/api/v2/package/Microsoft.Graph.Identity.DirectoryManagement/1.9.0"
                            }
                        ],
                        "runbooks": [
                            {
                                "name": "[variables('advisorExportsRunbookName')]",
                                "version": "1.3.0.0",
                                "description": "Exports Azure Advisor recommendations to Blob Storage using the Advisor API",
                                "type": "PowerShell",
                                "scriptUri": "[uri(parameters('_artifactsLocation'), concat('runbooks/data-collection/',variables('advisorExportsRunbookName'),'.ps1', parameters('artifactsLocationSasToken')))]"
                            },
                            {
                                "name": "[variables('argDisksExportsRunbookName')]",
                                "version": "1.3.2.0",
                                "description": "Exports Managed Disks properties to Blob Storage using Azure Resource Graph",
                                "type": "PowerShell",
                                "scriptUri": "[uri(parameters('_artifactsLocation'), concat('runbooks/data-collection/',variables('argDisksExportsRunbookName'),'.ps1', parameters('artifactsLocationSasToken')))]"
                            },
                            {
                                "name": "[variables('argVhdExportsRunbookName')]",
                                "version": "1.1.2.0",
                                "description": "Exports Unmanaged Disks (owned by a VM) properties to Blob Storage using Azure Resource Graph",
                                "type": "PowerShell",
                                "scriptUri": "[uri(parameters('_artifactsLocation'), concat('runbooks/data-collection/',variables('argVhdExportsRunbookName'),'.ps1', parameters('artifactsLocationSasToken')))]"
                            },
                            {
                                "name": "[variables('argVmExportsRunbookName')]",
                                "version": "1.4.2.0",
                                "description": "Exports Virtual Machine properties to Blob Storage using Azure Resource Graph",
                                "type": "PowerShell",
                                "scriptUri": "[uri(parameters('_artifactsLocation'), concat('runbooks/data-collection/',variables('argVmExportsRunbookName'),'.ps1', parameters('artifactsLocationSasToken')))]"
                            },
                            {
                                "name": "[variables('argVmssExportsRunbookName')]",
                                "version": "1.0.0.0",
                                "description": "Exports VMSS properties to Blob Storage using Azure Resource Graph",
                                "type": "PowerShell",
                                "scriptUri": "[uri(parameters('_artifactsLocation'), concat('runbooks/data-collection/',variables('argVmssExportsRunbookName'),'.ps1', parameters('artifactsLocationSasToken')))]"
                            },
                            {
                                "name": "[variables('argAvailSetExportsRunbookName')]",
                                "version": "1.1.2.0",
                                "description": "Exports Availability Set properties to Blob Storage using Azure Resource Graph",
                                "type": "PowerShell",
                                "scriptUri": "[uri(parameters('_artifactsLocation'), concat('runbooks/data-collection/',variables('argAvailSetExportsRunbookName'),'.ps1', parameters('artifactsLocationSasToken')))]"
                            },
                            {
                                "name": "[variables('consumptionExportsRunbookName')]",
                                "version": "1.1.1.0",
                                "description": "Exports Azure Consumption events to Blob Storage using Azure Consumption API",
                                "type": "PowerShell",
                                "scriptUri": "[uri(parameters('_artifactsLocation'), concat('runbooks/data-collection/',variables('consumptionExportsRunbookName'),'.ps1', parameters('artifactsLocationSasToken')))]"
                            },
                            {
                                "name": "[variables('aadObjectsExportsRunbookName')]",
                                "version": "1.1.2.0",
                                "description": "Exports Azure AAD Objects to Blob Storage using Azure ARM API",
                                "type": "PowerShell",
                                "scriptUri": "[uri(parameters('_artifactsLocation'), concat('runbooks/data-collection/',variables('aadObjectsExportsRunbookName'),'.ps1', parameters('artifactsLocationSasToken')))]"
                            },
                            {
                                "name": "[variables('argLoadBalancersExportsRunbookName')]",
                                "version": "1.1.2.0",
                                "description": "Exports Load Balancer properties to Blob Storage using Azure Resource Graph",
                                "type": "PowerShell",
                                "scriptUri": "[uri(parameters('_artifactsLocation'), concat('runbooks/data-collection/',variables('argLoadBalancersExportsRunbookName'),'.ps1', parameters('artifactsLocationSasToken')))]"
                            },
                            {
                                "name": "[variables('argAppGWsExportsRunbookName')]",
                                "version": "1.1.2.0",
                                "description": "Exports Application Gateway properties to Blob Storage using Azure Resource Graph",
                                "type": "PowerShell",
                                "scriptUri": "[uri(parameters('_artifactsLocation'), concat('runbooks/data-collection/',variables('argAppGWsExportsRunbookName'),'.ps1', parameters('artifactsLocationSasToken')))]"
                            },
                            {
                                "name": "[variables('argResContainersExportsRunbookName')]",
                                "version": "1.0.2.0",
                                "description": "Exports Resource Containers properties to Blob Storage using Azure Resource Graph",
                                "type": "PowerShell",
                                "scriptUri": "[uri(parameters('_artifactsLocation'), concat('runbooks/data-collection/',variables('argResContainersExportsRunbookName'),'.ps1', parameters('artifactsLocationSasToken')))]"
                            },
                            {
                                "name": "[variables('rbacExportsRunbookName')]",
                                "version": "1.0.0.0",
                                "description": "Exports RBAC assignments to Blob Storage using ARM and Azure AD",
                                "type": "PowerShell",
                                "scriptUri": "[uri(parameters('_artifactsLocation'), concat('runbooks/data-collection/',variables('rbacExportsRunbookName'),'.ps1', parameters('artifactsLocationSasToken')))]"
                            },
                            {
                                "name": "[variables('argNICExportsRunbookName')]",
                                "version": "1.0.0.0",
                                "description": "Exports NIC properties to Blob Storage using Azure Resource Graph",
                                "type": "PowerShell",
                                "scriptUri": "[uri(parameters('_artifactsLocation'), concat('runbooks/data-collection/',variables('argNICExportsRunbookName'),'.ps1', parameters('artifactsLocationSasToken')))]"
                            },
                            {
                                "name": "[variables('argNSGExportsRunbookName')]",
                                "version": "1.0.0.0",
                                "description": "Exports NSG properties to Blob Storage using Azure Resource Graph",
                                "type": "PowerShell",
                                "scriptUri": "[uri(parameters('_artifactsLocation'), concat('runbooks/data-collection/',variables('argNSGExportsRunbookName'),'.ps1', parameters('artifactsLocationSasToken')))]"
                            },
                            {
                                "name": "[variables('argPublicIpExportsRunbookName')]",
                                "version": "1.0.0.0",
                                "description": "Exports Public IP properties to Blob Storage using Azure Resource Graph",
                                "type": "PowerShell",
                                "scriptUri": "[uri(parameters('_artifactsLocation'), concat('runbooks/data-collection/',variables('argPublicIpExportsRunbookName'),'.ps1', parameters('artifactsLocationSasToken')))]"
                            },
                            {
                                "name": "[variables('argVNetExportsRunbookName')]",
                                "version": "1.0.0.0",
                                "description": "Exports VNet properties to Blob Storage using Azure Resource Graph",
                                "type": "PowerShell",
                                "scriptUri": "[uri(parameters('_artifactsLocation'), concat('runbooks/data-collection/',variables('argVNetExportsRunbookName'),'.ps1', parameters('artifactsLocationSasToken')))]"
                            },
                            {
                                "name": "[variables('monitorExportsRunbookName')]",
                                "version": "1.0.0.0",
                                "description": "Exports Azure Monitor metrics to Blob Storage",
                                "type": "PowerShell",
                                "scriptUri": "[uri(parameters('_artifactsLocation'), concat('runbooks/data-collection/',variables('monitorExportsRunbookName'),'.ps1', parameters('artifactsLocationSasToken')))]"
                            },
                            {
                                "name": "[variables('csvIngestRunbookName')]",
                                "version": "1.4.4.0",
                                "description": "Ingests CSV blobs as custom logs to Log Analytics",
                                "type": "PowerShell",
                                "scriptUri": "[uri(parameters('_artifactsLocation'), concat('runbooks/data-collection/',variables('csvIngestRunbookName'),'.ps1', parameters('artifactsLocationSasToken')))]"
                            },
                            {
                                "name": "[variables('unattachedDisksRecommendationsRunbookName')]",
                                "version": "2.4.4.0",
                                "description": "Generates unattached disks recommendations",
                                "type": "PowerShell",
                                "scriptUri": "[uri(parameters('_artifactsLocation'), concat('runbooks/recommendations/',variables('unattachedDisksRecommendationsRunbookName'),'.ps1', parameters('artifactsLocationSasToken')))]"
                            },
                            {
                                "name": "[variables('advisorCostAugmentedRecommendationsRunbookName')]",
                                "version": "2.8.3.0",
                                "description": "Generates augmented Advisor Cost recommendations",
                                "type": "PowerShell",
                                "scriptUri": "[uri(parameters('_artifactsLocation'), concat('runbooks/recommendations/',variables('advisorCostAugmentedRecommendationsRunbookName'),'.ps1', parameters('artifactsLocationSasToken')))]"
                            },
                            {
                                "name": "[variables('advisorAsIsRecommendationsRunbookName')]",
                                "version": "1.5.3.0",
                                "description": "Generates all types of Advisor recommendations",
                                "type": "PowerShell",
                                "scriptUri": "[uri(parameters('_artifactsLocation'), concat('runbooks/recommendations/',variables('advisorAsIsRecommendationsRunbookName'),'.ps1', parameters('artifactsLocationSasToken')))]"
                            },
                            {
                                "name": "[variables('vmsHARecommendationsRunbookName')]",
                                "version": "1.0.0.0",
                                "description": "Generates VMs High Availability recommendations",
                                "type": "PowerShell",
                                "scriptUri": "[uri(parameters('_artifactsLocation'), concat('runbooks/recommendations/',variables('vmsHARecommendationsRunbookName'),'.ps1', parameters('artifactsLocationSasToken')))]"
                            },
                            {
                                "name": "[variables('longDeallocatedVmsRecommendationsRunbookName')]",
                                "version": "1.2.3.0",
                                "description": "Generates long deallocated VMs recommendations",
                                "type": "PowerShell",
                                "scriptUri": "[uri(parameters('_artifactsLocation'), concat('runbooks/recommendations/',variables('longDeallocatedVmsRecommendationsRunbookName'),'.ps1', parameters('artifactsLocationSasToken')))]"
                            },
                            {
                                "name": "[variables('aadExpiringCredsRecommendationsRunbookName')]",
                                "version": "1.1.8.0",
                                "description": "Generates AAD Objects with expiring credentials recommendations",
                                "type": "PowerShell",
                                "scriptUri": "[uri(parameters('_artifactsLocation'), concat('runbooks/recommendations/',variables('aadExpiringCredsRecommendationsRunbookName'),'.ps1', parameters('artifactsLocationSasToken')))]"
                            },
                            {
                                "name": "[variables('unusedLBsRecommendationsRunbookName')]",
                                "version": "1.2.5.0",
                                "description": "Generates unused Load Balancers recommendations",
                                "type": "PowerShell",
                                "scriptUri": "[uri(parameters('_artifactsLocation'), concat('runbooks/recommendations/',variables('unusedLBsRecommendationsRunbookName'),'.ps1', parameters('artifactsLocationSasToken')))]"
                            },
                            {
                                "name": "[variables('unusedAppGWsRecommendationsRunbookName')]",
                                "version": "1.2.4.0",
                                "description": "Generates unused Application Gateways recommendations",
                                "type": "PowerShell",
                                "scriptUri": "[uri(parameters('_artifactsLocation'), concat('runbooks/recommendations/',variables('unusedAppGWsRecommendationsRunbookName'),'.ps1', parameters('artifactsLocationSasToken')))]"
                            },
                            {
                                "name": "[variables('armOptimizationsRecommendationsRunbookName')]",
                                "version": "1.0.1.0",
                                "description": "Generates ARM optimizations recommendations",
                                "type": "PowerShell",
                                "scriptUri": "[uri(parameters('_artifactsLocation'), concat('runbooks/recommendations/',variables('armOptimizationsRecommendationsRunbookName'),'.ps1', parameters('artifactsLocationSasToken')))]"
                            },
                            {
                                "name": "[variables('vnetOptimizationsRecommendationsRunbookName')]",
                                "version": "1.0.0.0",
                                "description": "Generates Virtual Network optimizations recommendations",
                                "type": "PowerShell",
                                "scriptUri": "[uri(parameters('_artifactsLocation'), concat('runbooks/recommendations/',variables('vnetOptimizationsRecommendationsRunbookName'),'.ps1', parameters('artifactsLocationSasToken')))]"
                            },
                            {
                                "name": "[variables('vmssOptimizationsRecommendationsRunbookName')]",
                                "version": "1.0.0.0",
                                "description": "Generates VM Scale Set optimizations recommendations",
                                "type": "PowerShell",
                                "scriptUri": "[uri(parameters('_artifactsLocation'), concat('runbooks/recommendations/',variables('vmssOptimizationsRecommendationsRunbookName'),'.ps1', parameters('artifactsLocationSasToken')))]"
                            },
                            {
                                "name": "[variables('recommendationsIngestRunbookName')]",
                                "version": "1.6.1.0",
                                "description": "Ingests JSON-based recommendations into an Azure SQL Database",
                                "type": "PowerShell",
                                "scriptUri": "[uri(parameters('_artifactsLocation'), concat('runbooks/recommendations/',variables('recommendationsIngestRunbookName'),'.ps1', parameters('artifactsLocationSasToken')))]"
                            },
                            {
                                "name": "[variables('advisorRightSizeFilteredRemediationRunbookName')]",
                                "version": "1.2.1.0",
                                "description": "Remediates Azure Advisor right-size recommendations given fit and tag filters",
                                "type": "PowerShell",
                                "scriptUri": "[uri(parameters('_artifactsLocation'), concat('runbooks/remediations/',variables('advisorRightSizeFilteredRemediationRunbookName'),'.ps1', parameters('artifactsLocationSasToken')))]"
                            },
                            {
                                "name": "[variables('longDeallocatedVMsFilteredRemediationRunbookName')]",
                                "version": "1.0.0.0",
                                "description": "Remediates long-deallocated VMs recommendations given fit and tag filters",
                                "type": "PowerShell",
                                "scriptUri": "[uri(parameters('_artifactsLocation'), concat('runbooks/remediations/',variables('longDeallocatedVMsFilteredRemediationRunbookName'),'.ps1', parameters('artifactsLocationSasToken')))]"
                            },
                            {
                                "name": "[variables('unattachedDisksFilteredRemediationRunbookName')]",
                                "version": "1.0.0.0",
                                "description": "Remediates unattached disks recommendations given fit and tag filters",
                                "type": "PowerShell",
                                "scriptUri": "[uri(parameters('_artifactsLocation'), concat('runbooks/remediations/',variables('unattachedDisksFilteredRemediationRunbookName'),'.ps1', parameters('artifactsLocationSasToken')))]"
                            }
                        ],
                        "automationVariables": [
                            {
                                "name": "AzureOptimization_CloudEnvironment",
                                "description": "Azure Cloud environment (e.g., AzureCloud, AzureChinaCloud, etc.)",
                                "value": "[concat('\"',parameters('cloudEnvironment'),'\"')]"
                            },
                            {
                                "name": "AzureOptimization_AuthenticationOption",
                                "description": "Runbook authentication type (RunAsAccount or ManagedIdentity)",
                                "value": "[concat('\"',parameters('authenticationOption'),'\"')]"
                            },
                            {
                                "name": "AzureOptimization_StorageSink",
                                "description": "The Azure Storage Account where data source exports are dumped to",
                                "value": "[concat('\"',parameters('storageAccountName'),'\"')]"
                            },
                            {
                                "name": "AzureOptimization_StorageSinkRG",
                                "description": "The resource group for the Azure Storage Account sink",
                                "value": "[concat('\"',resourceGroup().name,'\"')]"
                            },
                            {
                                "name": "AzureOptimization_StorageSinkSubId",
                                "description": "The subscription Id for the Azure Storage Account sink",
                                "value": "[concat('\"',subscription().subscriptionId,'\"')]"
                            },
                            {
                                "name": "AzureOptimization_ConsumptionOffsetDays",
                                "description": "The offset (in days) for querying for consumption data",
                                "value": 3
                            },
                            {
                                "name": "AzureOptimization_AdvisorFilter",
                                "description": "The category filter to use for Azure Advisor (non-Cost) recommendations exports",
                                "value": "[concat('\"','HighAvailability,Security,Performance,OperationalExcellence','\"')]"
                            },
                            {
                                "name": "AzureOptimization_ReferenceRegion",
                                "description": "The Azure region used as a reference for getting details about Azure VM sizes available",
                                "value": "[concat('\"',parameters('projectLocation'),'\"')]"
                            },
                            {
                                "name": "AzureOptimization_SQLServerDatabase",
                                "description": "The Azure SQL Database name for the ingestion control and recommendations tables",
                                "value": "[concat('\"',parameters('sqlDatabaseName'),'\"')]"
                            },
                            {
                                "name": "AzureOptimization_LogAnalyticsChunkSize",
                                "description": "The size (in rows) for each chunk of Log Analytics ingestion request",
                                "value": 9000
                            },
                            {
                                "name": "AzureOptimization_StorageBlobsPageSize",
                                "description": "The size (in blobs count) for each page of Storage Account container blob listing",
                                "value": 1000
                            },
                            {
                                "name": "AzureOptimization_SQLServerInsertSize",
                                "description": "The size (in inserted lines) for each page of recommendations ingestion into the SQL Database",
                                "value": 900
                            },
                            {
                                "name": "AzureOptimization_LogAnalyticsLogPrefix",
                                "description": "The prefix for all Azure Optimization custom log tables in Log Analytics",
                                "value": "[concat('\"','AzureOptimization','\"')]"
                            },
                            {
                                "name": "AzureOptimization_LogAnalyticsWorkspaceName",
                                "description": "The Log Analytics Workspace Name where optimization data will be ingested",
                                "value": "[concat('\"', parameters('logAnalyticsWorkspaceName'), '\"')]"
                            },
                            {
                                "name": "AzureOptimization_LogAnalyticsWorkspaceRG",
                                "description": "The resource group for the Log Analytics Workspace where optimization data will be ingested",
                                "value": "[concat('\"', if(not(parameters('logAnalyticsReuse')), resourceGroup().name, parameters('logAnalyticsWorkspaceRG')), '\"')]"
                            },
                            {
                                "name": "AzureOptimization_LogAnalyticsWorkspaceSubId",
                                "description": "The Azure subscription for the Log Analytics Workspace where optimization data will be ingested",
                                "value": "[concat('\"', subscription().subscriptionId, '\"')]"
                            },
                            {
                                "name": "AzureOptimization_LogAnalyticsWorkspaceTenantId",
                                "description": "The Azure AD tenant for the Log Analytics Workspace where optimization data will be ingested",
                                "value": "[concat('\"', subscription().tenantId, '\"')]"
                            },
                            {
                                "name": "AzureOptimization_RecommendAdvisorPeriodInDays",
                                "description": "The period (in days) to look back for Advisor exported recommendations",
                                "value": 7
                            },
                            {
                                "name": "AzureOptimization_RecommendationLongDeallocatedVmsIntervalDays",
                                "description": "The period (in days) for considering a VM long deallocated",
                                "value": 30
                            },
                            {
                                "name": "AzureOptimization_PerfPercentileCpu",
                                "description": "The percentile to be used for processor metrics",
                                "value": 99
                            },
                            {
                                "name": "AzureOptimization_PerfPercentileMemory",
                                "description": "The percentile to be used for memory metrics",
                                "value": 99
                            },
                            {
                                "name": "AzureOptimization_PerfPercentileNetwork",
                                "description": "The percentile to be used for network metrics",
                                "value": 99
                            },
                            {
                                "name": "AzureOptimization_PerfPercentileDisk",
                                "description": "The percentile to be used for disk metrics",
                                "value": 99
                            },
                            {
                                "name": "AzureOptimization_PerfThresholdCpuPercentage",
                                "description": "The processor usage percentage threshold above which the fit score is decreased or below which the instance is considered underutilized",
                                "value": 30
                            },
                            {
                                "name": "AzureOptimization_PerfThresholdMemoryPercentage",
                                "description": "The memory usage percentage threshold above which the fit score is decreased or below which the instance is considered underutilized",
                                "value": 50
                            },
                            {
                                "name": "AzureOptimization_PerfThresholdCpuDegradedMaxPercentage",
                                "description": "The maximum processor usage percentage threshold above which the instance is considered degraded",
                                "value": 95
                            },
                            {
                                "name": "AzureOptimization_PerfThresholdCpuDegradedAvgPercentage",
                                "description": "The average processor usage percentage threshold above which the instance is considered degraded",
                                "value": 70
                            },
                            {
                                "name": "AzureOptimization_PerfThresholdMemoryDegradedPercentage",
                                "description": "The memory usage percentage threshold above which the instance is considered degraded",
                                "value": 80
                            },
                            {
                                "name": "AzureOptimization_PerfThresholdNetworkMbps",
                                "description": "The network usage threshold (in Mbps) above which the fit score is decreased",
                                "value": 750
                            },
                            {
                                "name": "AzureOptimization_PerfThresholdCpuShutdownPercentage",
                                "description": "The processor usage percentage threshold above which the fit score is decreased (shutdown scenarios)",
                                "value": 5
                            },
                            {
                                "name": "AzureOptimization_PerfThresholdMemoryShutdownPercentage",
                                "description": "The memory usage percentage threshold above which the fit score is decreased (shutdown scenarios)",
                                "value": 100
                            },
                            {
                                "name": "AzureOptimization_PerfThresholdNetworkShutdownMbps",
                                "description": "The network usage threshold (in Mbps) above which the fit score is decreased (shutdown scenarios)",
                                "value": 10
                            },
                            {
                                "name": "AzureOptimization_RemediateRightSizeMinFitScore",
                                "description": "The minimum fit score for right-size remediation",
                                "value": "[concat('\"','5.0','\"')]"
                            },
                            {
                                "name": "AzureOptimization_RemediateRightSizeMinWeeksInARow",
                                "description": "The minimum number of weeks in a row required for a right-size recommendation to be remediated",
                                "value": 4
                            },
                            {
                                "name": "AzureOptimization_RecommendationAdvisorCostRightSizeId",
                                "description": "The Azure Advisor VM right-size recommendation ID",
                                "value": "[concat('\"','e10b1381-5f0a-47ff-8c7b-37bd13d7c974','\"')]"
                            },
                            {
                                "name": "AzureOptimization_RemediateLongDeallocatedVMsMinFitScore",
                                "description": "The minimum fit score for long-deallocated VM remediation",
                                "value": "[concat('\"','5.0','\"')]"
                            },
                            {
                                "name": "AzureOptimization_RemediateLongDeallocatedVMsMinWeeksInARow",
                                "description": "The minimum number of weeks in a row required for a long-deallocated VM recommendation to be remediated",
                                "value": 4
                            },
                            {
                                "name": "AzureOptimization_RecommendationLongDeallocatedVMsId",
                                "description": "The long deallocated VM recommendation ID",
                                "value": "[concat('\"','c320b790-2e58-452a-aa63-7b62c383ad8a','\"')]"
                            },
                            {
                                "name": "AzureOptimization_RemediateUnattachedDisksMinFitScore",
                                "description": "The minimum fit score for unattached disk remediation",
                                "value": "[concat('\"','5.0','\"')]"
                            },
                            {
                                "name": "AzureOptimization_RemediateUnattachedDisksMinWeeksInARow",
                                "description": "The minimum number of weeks in a row required for a unattached disk recommendation to be remediated",
                                "value": 4
                            },
                            {
                                "name": "AzureOptimization_RemediateUnattachedDisksAction",
                                "description": "The action for the unattached disk recommendation to be remediated (Delete or Downsize)",
                                "value": "[concat('\"','Delete','\"')]"
                            },
                            {
                                "name": "AzureOptimization_RecommendationUnattachedDisksId",
                                "description": "The unattached disk recommendation ID",
                                "value": "[concat('\"','c84d5e86-e2d6-4d62-be7c-cecfbd73b0db','\"')]"
                            },
                            {
                                "name": "AzureOptimization_RecommendationAADMinCredValidityDays",
                                "description": "The minimum validity of an AAD Object credential in days",
                                "value": 30
                            },
                            {
                                "name": "AzureOptimization_RecommendationAADMaxCredValidityYears",
                                "description": "The maximum validity of an AAD Object credential in years",
                                "value": 2
                            },
                            {
                                "name": "AzureOptimization_AADObjectsFilter",
                                "description": "The Azure AD object types to export",
                                "value": "[concat('\"','Application,ServicePrincipal,User,Group','\"')]"
                            },
                            {
                                "name": "AzureOptimization_RecommendationRBACAssignmentsPercentageThreshold",
                                "description": "The percentage threshold (used to trigger recommendations) for total RBAC assignments limits",
                                "value": 80
                            },
                            {
                                "name": "AzureOptimization_RecommendationResourceGroupsPerSubPercentageThreshold",
                                "description": "The percentage threshold (used to trigger recommendations) for resource group count limits",
                                "value": 80
                            },
                            {
                                "name": "AzureOptimization_RecommendationVNetSubnetMaxUsedPercentageThreshold",
                                "description": "The percentage threshold (used to trigger recommendations) for maximum subnet address space usage",
                                "value": 80
                            },
                            {
                                "name": "AzureOptimization_RecommendationVNetSubnetMinUsedPercentageThreshold",
                                "description": "The percentage threshold (used to trigger recommendations) for minimum subnet address space usage",
                                "value": 5
                            },
                            {
                                "name": "AzureOptimization_RecommendationVNetSubnetEmptyMinAgeInDays",
                                "description": "The minimum age (in days) for an empty subnet to trigger an NSG rule recommendation",
                                "value": 30
                            }
                        ],
                        "roleContributor": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Authorization/roleDefinitions/', 'b24988ac-6180-42a0-ab88-20f7382dd24c')]"
                    },
                    "resources": [
                        // Log Analytics Workspace
                        {
                            "condition": "[not(parameters('logAnalyticsReuse'))]",
                            "type": "microsoft.operationalinsights/workspaces",
                            "apiVersion": "[variables('apiVersions').operationalInsights]",
                            "name": "[parameters('logAnalyticsWorkspaceName')]",
                            "location": "[parameters('projectLocation')]",
                            "properties": {
                                "sku": {
                                    "name": "pergb2018"
                                },
                                "retentionInDays": "[parameters('logAnalyticsRetentionDays')]"
                            }
                        },
                        // Storage Account
                        {
                            "type": "Microsoft.Storage/storageAccounts",
                            "apiVersion": "[variables('apiVersions').storage]",
                            "name": "[parameters('storageAccountName')]",
                            "location": "[parameters('projectLocation')]",
                            "sku": {
                                "name": "Standard_LRS",
                                "tier": "Standard"
                            },
                            "kind": "StorageV2",
                            "properties": {
                                "networkAcls": {
                                    "bypass": "AzureServices",
                                    "virtualNetworkRules": [
                                    ],
                                    "ipRules": [
                                    ],
                                    "defaultAction": "Allow"
                                },
                                "supportsHttpsTrafficOnly": true,
                                "encryption": {
                                    "services": {
                                        "file": {
                                            "enabled": true
                                        },
                                        "blob": {
                                            "enabled": true
                                        }
                                    },
                                    "keySource": "Microsoft.Storage"
                                },
                                "accessTier": "Cool"
                            }
                        },
                        // Storage Account Blob Services
                        {
                            "type": "Microsoft.Storage/storageAccounts/blobServices",
                            "apiVersion": "[variables('apiVersions').storage]",
                            "name": "[concat(parameters('storageAccountName'), '/default')]",
                            "dependsOn": [
                                "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]"
                            ],
                            "sku": {
                                "name": "Standard_LRS"
                            },
                            "properties": {
                                "cors": {
                                    "corsRules": [
                                    ]
                                },
                                "deleteRetentionPolicy": {
                                    "enabled": false
                                }
                            }
                        },
                        // Storage Account containers
                        {
                            "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
                            "apiVersion": "[variables('apiVersions').storage]",
                            "name": "[concat(parameters('storageAccountName'), '/default/', variables('csvExports')[copyIndex()].containerName)]",
                            "dependsOn": [
                                "[resourceId('Microsoft.Storage/storageAccounts/blobServices', parameters('storageAccountName'), 'default')]",
                                "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]"
                            ],
                            "copy": {
                                "name": "containersLoop",
                                "count": "[length(variables('csvExports'))]"
                            },
                            "properties": {
                                "publicAccess": "None"
                            }
                        },
                        // Storage Account Recommendations container
                        {
                            "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
                            "apiVersion": "[variables('apiVersions').storage]",
                            "name": "[concat(parameters('storageAccountName'), '/default/', variables('recommendationsContainerName'))]",
                            "dependsOn": [
                                "[resourceId('Microsoft.Storage/storageAccounts/blobServices', parameters('storageAccountName'), 'default')]",
                                "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]"
                            ],
                            "properties": {
                                "publicAccess": "None"
                            }
                        },
                        // Storage Account Remediations Logs container
                        {
                            "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
                            "apiVersion": "[variables('apiVersions').storage]",
                            "name": "[concat(parameters('storageAccountName'), '/default/', variables('remediationLogsContainerName'))]",
                            "dependsOn": [
                                "[resourceId('Microsoft.Storage/storageAccounts/blobServices', parameters('storageAccountName'), 'default')]",
                                "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]"
                            ],
                            "properties": {
                                "publicAccess": "None"
                            }
                        },
                        // Azure SQL Server
                        {
                            "type": "Microsoft.Sql/servers",
                            "apiVersion": "[variables('apiVersions').sql]",
                            "name": "[parameters('sqlServerName')]",
                            "location": "[parameters('projectLocation')]",
                            "kind": "v12.0",
                            "properties": {
                                "administratorLogin": "[parameters('sqlAdminLogin')]",
                                "administratorLoginPassword": "[parameters('sqlAdminPassword')]",
                                "version": "12.0",
                                "publicNetworkAccess": "Enabled"
                            },
                            "resources": [
                                {
                                    "type": "firewallRules",
                                    "apiVersion": "[variables('apiVersions').sql]",
                                    "name": "AllowAllWindowsAzureIps",
                                    "location": "[parameters('projectLocation')]",
                                    "dependsOn": [
                                        "[resourceId('Microsoft.Sql/servers', parameters('sqlServerName'))]"
                                    ],
                                    "properties": {
                                        "endIpAddress": "0.0.0.0",
                                        "startIpAddress": "0.0.0.0"
                                    }
                                }
                            ]
                        },
                        // Azure SQL Database
                        {
                            "type": "Microsoft.Sql/servers/databases",
                            "apiVersion": "[variables('apiVersions').sql]",
                            "name": "[concat(parameters('sqlServerName'), '/', parameters('sqlDatabaseName'))]",
                            "location": "[parameters('projectLocation')]",
                            "dependsOn": [
                                "[resourceId('Microsoft.Sql/servers', parameters('sqlServerName'))]"
                            ],
                            "sku": {
                                "name": "Basic",
                                "tier": "Basic",
                                "capacity": 5
                            },
                            "kind": "v12.0,user",
                            "properties": {
                                "collation": "SQL_Latin1_General_CP1_CI_AS",
                                "maxSizeBytes": 2147483648,
                                "catalogCollation": "SQL_Latin1_General_CP1_CI_AS",
                                "zoneRedundant": false,
                                "readScale": "Disabled",
                                "readReplicaCount": 0,
                                "autoPauseDelay": 60,
                                "storageAccountType": "GRS"
                            }
                        },
                        // Azure SQL backup retention policy
                        {
                            "type": "Microsoft.Sql/servers/databases/backupShortTermRetentionPolicies",
                            "apiVersion": "[variables('apiVersions').sql]",
                            "name": "[concat(parameters('sqlServerName'), '/', parameters('sqlDatabaseName'), '/default')]",
                            "dependsOn": [
                                "[resourceId('Microsoft.Sql/servers/databases', parameters('sqlServerName'), parameters('sqlDatabaseName'))]",
                                "[resourceId('Microsoft.Sql/servers', parameters('sqlServerName'))]"
                            ],
                            "properties": {
                                "retentionDays": "[parameters('sqlBackupRetentionDays')]"
                            }
                        },
                        // Automation Account
                        {
                            "type": "Microsoft.Automation/automationAccounts",
                            "apiVersion": "[variables('apiVersions').automation]",
                            "name": "[parameters('automationAccountName')]",
                            "location": "[parameters('projectLocation')]",
                            "identity": {
                                "type": "SystemAssigned"
                            },
                            "properties": {
                                "sku": {
                                    "name": "Basic"
                                }
                            }
                        },
                        // Automation Modules (Az.Account)
                        {
                            "comments": "provision the Az.Accounts module first since others are dependent on it",
                            "name": "[concat(parameters('automationAccountName'), '/', variables('Az.Accounts').name)]",
                            "type": "Microsoft.Automation/automationAccounts/modules",
                            "apiVersion": "[variables('apiVersions').automation]",
                            "dependsOn": [
                                "[resourceId('Microsoft.Automation/automationAccounts', parameters('automationAccountName'))]"
                            ],
                            "properties": {
                                "contentLink": {
                                    "uri": "[variables('Az.Accounts').url]"
                                }
                            }
                        },
                        // Automation Modules (Microsoft.Graph.Authentication)
                        {
                            "comments": "provision the Microsoft.Graph.Authentication module first since others are dependent on it",
                            "name": "[concat(parameters('automationAccountName'), '/', variables('Microsoft.Graph.Authentication').name)]",
                            "type": "Microsoft.Automation/automationAccounts/modules",
                            "apiVersion": "[variables('apiVersions').automation]",
                            "dependsOn": [
                                "[resourceId('Microsoft.Automation/automationAccounts', parameters('automationAccountName'))]"
                            ],
                            "properties": {
                                "contentLink": {
                                    "uri": "[variables('Microsoft.Graph.Authentication').url]"
                                }
                            }
                        },
                        // Automation Modules (other)
                        {
                            "name": "[concat(parameters('automationAccountName'), '/', variables('psModules')[copyIndex()].name)]",
                            "type": "Microsoft.Automation/automationAccounts/modules",
                            "apiVersion": "[variables('apiVersions').automation]",
                            "dependsOn": [
                                "[resourceId('Microsoft.Automation/automationAccounts', parameters('automationAccountName'))]",
                                "[variables('Az.Accounts').name]"
                            ],
                            "copy": {
                                "name": "modulesLoop",
                                "count": "[length(variables('psModules'))]"
                            },
                            "properties": {
                                "contentLink": {
                                    "uri": "[variables('psModules')[copyIndex()].url]"
                                }
                            }
                        },
                        // Automation Runbooks
                        {
                            "name": "[concat(parameters('automationAccountName'), '/', variables('runbooks')[copyIndex()].name)]",
                            "type": "Microsoft.Automation/automationAccounts/runbooks",
                            "apiVersion": "[variables('apiVersions').automation]",
                            "location": "[parameters('projectLocation')]",
                            "dependsOn": [
                                "[resourceId('Microsoft.Automation/automationAccounts', parameters('automationAccountName'))]",
                                "[variables('Az.Accounts').name]",
                                "modulesLoop"
                            ],
                            "copy": {
                                "name": "runbooksLoop",
                                "count": "[length(variables('runbooks'))]"
                            },
                            "properties": {
                                "runbookType": "[variables('runbooks')[copyIndex()].type]",
                                "logProgress": false,
                                "logVerbose": false,
                                "description": "[variables('runbooks')[copyIndex()].description]",
                                "publishContentLink": {
                                    "uri": "[variables('runbooks')[copyIndex()].scriptUri]",
                                    "version": "[variables('runbooks')[copyIndex()].version]"
                                }
                            }
                        },
                        // Automation Variables
                        {
                            "type": "Microsoft.Automation/automationAccounts/variables",
                            "apiVersion": "[variables('apiVersions').automation]",
                            "name": "[concat(parameters('automationAccountName'), '/', variables('automationVariables')[copyIndex()].name)]",
                            "dependsOn": [
                                "[resourceId('Microsoft.Automation/automationAccounts', parameters('automationAccountName'))]"
                            ],
                            "copy": {
                                "name": "variableLoop",
                                "count": "[length(variables('automationVariables'))]"
                            },
                            "properties": {
                                "description": "[variables('automationVariables')[copyIndex()].description]",
                                "value": "[variables('automationVariables')[copyIndex()].value]"
                            }
                        },
                        // Automation Export Container Variables
                        {
                            "type": "Microsoft.Automation/automationAccounts/variables",
                            "apiVersion": "[variables('apiVersions').automation]",
                            "name": "[concat(parameters('automationAccountName'), '/', variables('csvExports')[copyIndex()].variableName)]",
                            "dependsOn": [
                                "[resourceId('Microsoft.Automation/automationAccounts', parameters('automationAccountName'))]"
                            ],
                            "copy": {
                                "name": "containerVariableLoop",
                                "count": "[length(variables('csvExports'))]"
                            },
                            "properties": {
                                "description": "[variables('csvExports')[copyIndex()].variableDescription]",
                                "value": "[concat('\"',variables('csvExports')[copyIndex()].containerName,'\"')]"
                            }
                        },
                        // Automation Variables (SQL Server Hostname)
                        {
                            "type": "Microsoft.Automation/automationAccounts/variables",
                            "apiVersion": "[variables('apiVersions').automation]",
                            "name": "[concat(parameters('automationAccountName'), '/AzureOptimization_SQLServerHostname')]",
                            "dependsOn": [
                                "[resourceId('Microsoft.Automation/automationAccounts', parameters('automationAccountName'))]",
                                "[resourceId('Microsoft.Sql/servers', parameters('sqlServerName'))]"
                            ],
                            "properties": {
                                "description": "The Azure SQL Server hostname for the ingestion control and recommendations tables",
                                "value": "[concat('\"', reference(resourceId('Microsoft.Sql/servers', parameters('sqlServerName')), variables('apiVersions').sql).fullyQualifiedDomainName, '\"')]"
                            }
                        },
                        // Automation Variables (Log Analytics workspace Id)
                        {
                            "type": "Microsoft.Automation/automationAccounts/variables",
                            "apiVersion": "[variables('apiVersions').automation]",
                            "name": "[concat(parameters('automationAccountName'), '/AzureOptimization_LogAnalyticsWorkspaceId')]",
                            "dependsOn": [
                                "[resourceId('Microsoft.Automation/automationAccounts', parameters('automationAccountName'))]",
                                "[if(not(parameters('logAnalyticsReuse')),resourceId('microsoft.operationalinsights/workspaces', parameters('logAnalyticsWorkspaceName')),'variableLoop')]"
                            ],
                            "properties": {
                                "description": "The Log Analytics Workspace ID where optimization data will be ingested",
                                "value": "[concat('\"', reference(if(not(parameters('logAnalyticsReuse')), resourceId('microsoft.operationalinsights/workspaces', parameters('logAnalyticsWorkspaceName')), resourceId(parameters('logAnalyticsWorkspaceRG'), 'microsoft.operationalinsights/workspaces', parameters('logAnalyticsWorkspaceName'))), variables('apiVersions').operationalInsights).customerId, '\"')]"
                            }
                        },
                        // Automation Variables (Log Analytics workspace key)
                        {
                            "type": "Microsoft.Automation/automationAccounts/variables",
                            "apiVersion": "[variables('apiVersions').automation]",
                            "name": "[concat(parameters('automationAccountName'), '/AzureOptimization_LogAnalyticsWorkspaceKey')]",
                            "dependsOn": [
                                "[resourceId('Microsoft.Automation/automationAccounts', parameters('automationAccountName'))]",
                                "[if(not(parameters('logAnalyticsReuse')),resourceId('microsoft.operationalinsights/workspaces', parameters('logAnalyticsWorkspaceName')),'variableLoop')]"
                            ],
                            "properties": {
                                "description": "The shared key for the Log Analytics Workspace where optimization data will be ingested",
                                "value": "[concat('\"', listKeys(if(not(parameters('logAnalyticsReuse')), resourceId('microsoft.operationalinsights/workspaces', parameters('logAnalyticsWorkspaceName')), resourceId(parameters('logAnalyticsWorkspaceRG'), 'microsoft.operationalinsights/workspaces', parameters('logAnalyticsWorkspaceName'))),variables('apiVersions').operationalInsights).primarySharedKey, '\"')]",
                                "isEncrypted": true
                            }
                        },
                        // Automation Credentials
                        {
                            "name": "[concat(parameters('automationAccountName'), '/AzureOptimization_SQLServerCredential')]",
                            "type": "Microsoft.Automation/automationAccounts/credentials",
                            "apiVersion": "[variables('apiVersions').automation]",
                            "dependsOn": [
                                "[resourceId('Microsoft.Automation/automationAccounts', parameters('automationAccountName'))]"
                            ],
                            "properties": {
                                "description": "Azure Optimization SQL Database Credentials",
                                "password": "[parameters('sqlAdminPassword')]",
                                "userName": "[parameters('sqlAdminLogin')]"
                            }
                        },
                        // Automation Storage Exports Schedule
                        {
                            "name": "[concat(parameters('automationAccountName'), '/', variables('csvExportsSchedules')[copyIndex()].exportSchedule)]",
                            "type": "Microsoft.Automation/automationAccounts/schedules",
                            "apiVersion": "[variables('apiVersions').automation]",
                            "dependsOn": [
                                "[resourceId('Microsoft.Automation/automationAccounts', parameters('automationAccountName'))]"
                            ],
                            "copy": {
                                "name": "exportSchedulesLoop",
                                "count": "[length(variables('csvExportsSchedules'))]"
                            },
                            "properties": {
                                "description": "[variables('csvExportsSchedules')[copyIndex()].exportDescription]",
                                "expiryTime": "9999-12-31T17:59:00-06:00",
                                "isEnabled": true,
                                "startTime": "[dateTimeAdd(parameters('baseTime'), variables('csvExportsSchedules')[copyIndex()].exportTimeOffset)]",
                                "interval": 1,
                                "frequency": "[variables('csvExportsSchedules')[copyIndex()].exportFrequency]"
                            }
                        },
                        // Automation Log Analytics Ingest Schedules for generic CSV Storage Accounts exports
                        {
                            "name": "[concat(parameters('automationAccountName'), '/', variables('csvExports')[copyIndex()].ingestSchedule)]",
                            "type": "Microsoft.Automation/automationAccounts/schedules",
                            "apiVersion": "[variables('apiVersions').automation]",
                            "dependsOn": [
                                "[resourceId('Microsoft.Automation/automationAccounts', parameters('automationAccountName'))]"
                            ],
                            "copy": {
                                "name": "ingestSchedulesLoop",
                                "count": "[length(variables('csvExports'))]"
                            },
                            "properties": {
                                "description": "[variables('csvExports')[copyIndex()].ingestDescription]",
                                "expiryTime": "9999-12-31T17:59:00-06:00",
                                "isEnabled": true,
                                "startTime": "[dateTimeAdd(parameters('baseTime'), variables('csvExports')[copyIndex()].ingestTimeOffset)]",
                                "interval": 1,
                                "frequency": "[variables('csvExports')[copyIndex()].ingestFrequency]"
                            }
                        },
                        // Automation Remediation Logs Ingest Schedule
                        {
                            "name": "[concat(parameters('automationAccountName'), '/', variables('remediationLogsIngestScheduleName'))]",
                            "type": "Microsoft.Automation/automationAccounts/schedules",
                            "apiVersion": "[variables('apiVersions').automation]",
                            "dependsOn": [
                                "[resourceId('Microsoft.Automation/automationAccounts', parameters('automationAccountName'))]"
                            ],
                            "properties": {
                                "description": "Starts the daily Remediation Logs ingests",
                                "expiryTime": "9999-12-31T17:59:00-06:00",
                                "isEnabled": true,
                                "startTime": "[dateTimeAdd(parameters('baseTime'), 'PT1H30M')]",
                                "interval": 1,
                                "frequency": "Day"
                            }
                        },
                        // Automation Recommendations Generation Schedule
                        {
                            "name": "[concat(parameters('automationAccountName'), '/', variables('recommendationsScheduleName'))]",
                            "type": "Microsoft.Automation/automationAccounts/schedules",
                            "apiVersion": "[variables('apiVersions').automation]",
                            "dependsOn": [
                                "[resourceId('Microsoft.Automation/automationAccounts', parameters('automationAccountName'))]"
                            ],
                            "properties": {
                                "description": "Starts the weekly Recommendations generation",
                                "expiryTime": "9999-12-31T17:59:00-06:00",
                                "isEnabled": true,
                                "startTime": "[dateTimeAdd(parameters('baseTime'), 'PT2H30M')]",
                                "interval": 1,
                                "frequency": "Week"
                            }
                        },
                        // Automation Recommendations Ingest Schedule
                        {
                            "name": "[concat(parameters('automationAccountName'), '/', variables('recommendationsIngestScheduleName'))]",
                            "type": "Microsoft.Automation/automationAccounts/schedules",
                            "apiVersion": "[variables('apiVersions').automation]",
                            "dependsOn": [
                                "[resourceId('Microsoft.Automation/automationAccounts', parameters('automationAccountName'))]"
                            ],
                            "properties": {
                                "description": "Starts the weekly Recommendations ingests",
                                "expiryTime": "9999-12-31T17:59:00-06:00",
                                "isEnabled": true,
                                "startTime": "[dateTimeAdd(parameters('baseTime'), 'PT3H30M')]",
                                "interval": 1,
                                "frequency": "Week"
                            }
                        },
                        // Automation Storage Exports Job Schedules
                        {
                            "condition": "[not(variables('csvExports')[copyIndex()].isOneToMany)]",
                            "name": "[concat(parameters('automationAccountName'), '/', variables('csvExports')[copyIndex()].exportJobId)]",
                            "type": "Microsoft.Automation/automationAccounts/jobSchedules",
                            "apiVersion": "[variables('apiVersions').automation]",
                            "location": "[parameters('projectLocation')]",
                            "dependsOn": [
                                "[resourceId('Microsoft.Automation/automationAccounts', parameters('automationAccountName'))]",
                                "exportSchedulesLoop",
                                "modulesLoop",
                                "runbooksLoop"
                            ],
                            "copy": {
                                "name": "exportJobSchedulesLoop",
                                "count": "[length(variables('csvExports'))]"
                            },
                            "properties": {
                                "schedule": {
                                    "name": "[variables('csvExports')[copyIndex()].exportSchedule]"
                                },
                                "runbook": {
                                    "name": "[variables('csvExports')[copyIndex()].runbookName]"
                                }
                            }
                        },
                        // Automation Storage Parameterized Exports Job Schedules
                        {
                            "name": "[concat(parameters('automationAccountName'), '/', variables('csvParameterizedExports')[copyIndex()].exportJobId)]",
                            "type": "Microsoft.Automation/automationAccounts/jobSchedules",
                            "apiVersion": "[variables('apiVersions').automation]",
                            "location": "[parameters('projectLocation')]",
                            "dependsOn": [
                                "[resourceId('Microsoft.Automation/automationAccounts', parameters('automationAccountName'))]",
                                "exportSchedulesLoop",
                                "modulesLoop",
                                "runbooksLoop"
                            ],
                            "copy": {
                                "name": "parameterizedExportJobSchedulesLoop",
                                "count": "[length(variables('csvParameterizedExports'))]"
                            },
                            "properties": {
                                "schedule": {
                                    "name": "[variables('csvParameterizedExports')[copyIndex()].exportSchedule]"
                                },
                                "runbook": {
                                    "name": "[variables('csvParameterizedExports')[copyIndex()].runbookName]"
                                },
                                "parameters": "[variables('csvParameterizedExports')[copyIndex()].parameters]"
                            }
                        },
                        // Automation Log Analytics Ingest Job Schedules for generic CSV Storage Exports
                        {
                            "name": "[concat(parameters('automationAccountName'), '/', variables('csvExports')[copyIndex()].ingestJobId)]",
                            "type": "Microsoft.Automation/automationAccounts/jobSchedules",
                            "apiVersion": "[variables('apiVersions').automation]",
                            "location": "[parameters('projectLocation')]",
                            "dependsOn": [
                                "[resourceId('Microsoft.Automation/automationAccounts', parameters('automationAccountName'))]",
                                "ingestSchedulesLoop",
                                "modulesLoop",
                                "[variables('csvIngestRunbookName')]"
                            ],
                            "copy": {
                                "name": "ingestJobSchedulesLoop",
                                "count": "[length(variables('csvExports'))]"
                            },
                            "properties": {
                                "schedule": {
                                    "name": "[variables('csvExports')[copyIndex()].ingestSchedule]"
                                },
                                "runbook": {
                                    "name": "[variables('csvIngestRunbookName')]"
                                },
                                "parameters": {
                                    "StorageSinkContainer": "[variables('csvExports')[copyIndex()].containerName]"
                                }
                            }
                        },
                        // Automation Log Analytics Ingest Job Schedules for Remediation Logs Storage Exports
                        {
                            "name": "[concat(parameters('automationAccountName'), '/', parameters('remediationLogsIngestJobId'))]",
                            "type": "Microsoft.Automation/automationAccounts/jobSchedules",
                            "apiVersion": "[variables('apiVersions').automation]",
                            "location": "[parameters('projectLocation')]",
                            "dependsOn": [
                                "[resourceId('Microsoft.Automation/automationAccounts', parameters('automationAccountName'))]",
                                "[variables('remediationLogsIngestScheduleName')]",
                                "[variables('csvIngestRunbookName')]"
                            ],
                            "properties": {
                                "schedule": {
                                    "name": "[variables('remediationLogsIngestScheduleName')]"
                                },
                                "runbook": {
                                    "name": "[variables('csvIngestRunbookName')]"
                                },
                                "parameters": {
                                    "StorageSinkContainer": "[variables('remediationLogsContainerName')]"
                                }
                            }
                        },
                        // Automation Recommendations Generation Job Schedule
                        {
                            "name": "[concat(parameters('automationAccountName'), '/', variables('recommendations')[copyIndex()].recommendationJobId)]",
                            "type": "Microsoft.Automation/automationAccounts/jobSchedules",
                            "apiVersion": "[variables('apiVersions').automation]",
                            "location": "[parameters('projectLocation')]",
                            "dependsOn": [
                                "[resourceId('Microsoft.Automation/automationAccounts', parameters('automationAccountName'))]",
                                "[variables('recommendationsScheduleName')]",
                                "modulesLoop",
                                "runbooksLoop"
                            ],
                            "copy": {
                                "name": "recommendationsJobSchedulesLoop",
                                "count": "[length(variables('recommendations'))]"
                            },
                            "properties": {
                                "schedule": {
                                    "name": "[variables('recommendationsScheduleName')]"
                                },
                                "runbook": {
                                    "name": "[variables('recommendations')[copyIndex()].runbookName]"
                                }
                            }
                        },
                        // Automation Recommendations Ingest Job Schedule
                        {
                            "name": "[concat(parameters('automationAccountName'), '/', parameters('recommendationsIngestJobId'))]",
                            "type": "Microsoft.Automation/automationAccounts/jobSchedules",
                            "apiVersion": "[variables('apiVersions').automation]",
                            "location": "[parameters('projectLocation')]",
                            "dependsOn": [
                                "[resourceId('Microsoft.Automation/automationAccounts', parameters('automationAccountName'))]",
                                "[variables('recommendationsIngestScheduleName')]",
                                "modulesLoop",
                                "[variables('recommendationsIngestRunbookName')]"
                            ],
                            "properties": {
                                "schedule": {
                                    "name": "[variables('recommendationsIngestScheduleName')]"
                                },
                                "runbook": {
                                    "name": "[variables('recommendationsIngestRunbookName')]"
                                }
                            }
                        },
                        {
                            "type": "Microsoft.Authorization/roleAssignments",
                            "apiVersion": "2018-09-01-preview",
                            "name": "[parameters('contributorRoleAssignmentGuid')]",
                            "dependsOn": [
                                "[resourceId('Microsoft.Automation/automationAccounts', parameters('automationAccountName'))]"
                            ],
                            "properties": {
                                "roleDefinitionId": "[variables('roleContributor')]",
                                "principalId": "[reference(resourceId('Microsoft.Automation/automationAccounts', parameters('automationAccountName')), '2019-06-01', 'Full').identity.principalId]",
                                "principalType": "ServicePrincipal"
                            }
                        }
                    ],
                    "outputs": {
                        "automationPrincipalId": {
                            "type": "string",
                            "value": "[reference(resourceId('Microsoft.Automation/automationAccounts', parameters('automationAccountName')), '2019-06-01', 'Full').identity.principalId]"
                        }
                    }
                }
            }
        },
        {
            "type": "Microsoft.Authorization/roleAssignments",
            "apiVersion": "2018-09-01-preview",
            "name": "[parameters('readerRoleAssignmentGuid')]",
            "dependsOn": [
                "resourcesDeployment"
            ],
            "properties": {
                "roleDefinitionId": "[variables('roleReader')]",
                "principalId": "[reference('resourcesDeployment').outputs.automationPrincipalId.value]",
                "principalType": "ServicePrincipal"
            }
        }
    ],
    "outputs": {
        "automationPrincipalId": {
            "type": "string",
            "value": "[reference('resourcesDeployment').outputs.automationPrincipalId.value]"
        }
    }
}